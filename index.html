<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title></title>
<meta name="author" content="(Aldric Giacomoni)"/>
<style type="text/css">
.underline { text-decoration: underline; }
</style>
<link rel="stylesheet" href="./reveal.js-3.8.0/css/reveal.css"/>

<link rel="stylesheet" href="./reveal.js-3.8.0/css/theme/solarized.css" id="theme"/>


<!-- If the query includes 'print-pdf', include the PDF print sheet -->
<script>
    if( window.location.search.match( /print-pdf/gi ) ) {
        var link = document.createElement( 'link' );
        link.rel = 'stylesheet';
        link.type = 'text/css';
        link.href = './reveal.js-3.8.0/css/print/pdf.css';
        document.getElementsByTagName( 'head' )[0].appendChild( link );
    }
</script>
</head>
<body>
<div class="reveal">
<div class="slides">

<section>
<section id="slide-orgb296beb">
<h2 id="orgb296beb">Dwarlixir</h2>
<p>
Mistakes were made
</p>
</section>
<section id="slide-org6b60748">
<h3 id="org6b60748">The Big Elixir 2019's theme</h3>
<p>
[Talks that present] <b>new ways of thinking</b> [...] and talk deeply about <b>lessons learned</b> [...].
</p>

<p>
We want to hear about [...] <b>the very strange</b>.
</p>

<aside class="notes">
<p>
My brain dropped pretty much everything except for these parts.
</p>

<p>
And I thought...
</p>

<p>
Perfect. I have just the thing.
</p>

</aside>
</section>
<section id="slide-orgc6c66e9">
<h4 id="orgc6c66e9">Who you're listening to</h4>
<p>
Aldric Giacomoni
</p>

<p>
<code>@trevoke</code>
</p>

<p>
Director of Engineering at Stash
</p>
<aside class="notes">
<p>
&lt;3 Ruby, Smalltalk，Lisp, Elixir
</p>

<p>
Wrote code for about a decade
</p>

<p>
&lt;3 extreme programming, lean, agile
</p>

<p>
Talk to me after the session!
</p>

<p>
We are hiring; our stack is Ruby and Scala, there's no Elixir... Yet!
</p>

</aside>
</section>
<section id="slide-org35de6a8">
<h4 id="org35de6a8">Why this talk? 1/2</h4>
<blockquote nil>
<p>
You got to lose to know
</p>

<p>
How to win
</p>

<p>
― Dream On, Aerosmith
</p>
</blockquote>

<aside class="notes">
<ul>
<li>never get to open with song lyrics</li>
<li>how cool am I?</li>
<li>two reasons</li>
<li>reason 1:</li>
<li>continuous improvement is critical</li>
<li>intentional experiments</li>
<li>failure</li>
<li>eventual success</li>
<li>In Radical Candor, Andy Grove says of Steve Jobs:</li>

</ul>
<p>
"I didn't say Steve <i>is</i> always right. I said he always <i>gets</i> it right. Like anyone, he is wrong sometimes, but he insists, and not gently either, that people tell him when he's wrong, so he always gets it right in the end."
</p>

</aside>
</section>
<section id="slide-org3e7ec76">
<h4 id="org3e7ec76">Why this talk? 2/2</h4>
<blockquote nil>
<p>
With every mistake we must surely be learning
</p>

<p>
Still my guitar gently weeps
</p>

<p>
― While My Guitar Gently Weeps, The Beatles
</p>
</blockquote>

<aside class="notes">
<ul>
<li>reason 2:</li>
<li>impostor syndrome is a thing</li>
<li>manifests differently for everyone</li>
<li>I've got this fancy title now</li>
<li>Made plenty of mistakes on the way</li>
<li>We learn well with stories</li>

</ul>

</aside>
</section>
<section id="slide-orgc7db506">
<h4 id="orgc7db506">Apparently obligatory</h4>
<p>
Why?!
</p>

<p>
Why this side project?
</p>

<aside class="notes">
<p>
Powell Kinney said this slide had to be there, so Ι added it.
</p>

<p>
why <i>NOT</i> ?
</p>

<p>
This project has spawned so many good conversations
</p>

<p>
So many lessons
</p>

<p>
So many side projects
</p>

<p>
... Even a small open source community
</p>

<p>
Cherish your ideas! Who knows what their impact will be?
</p>

</aside>
</section>
<section id="slide-org485ec5f">
<h3 id="org485ec5f">Establishing context</h3>
<p>
A mix of a MUD and Dwarf Fortress
</p>
</section>
<section id="slide-org1061f51">
<h4 id="org1061f51">What's a MUD?</h4>
<img class="stretch" src="discworld.png">

<aside class="notes">
<p>
Multi-User Dungeon
</p>

<p>
Text-based multiplayer game
</p>

<p>
Read description
</p>

<p>
Write commands
</p>

</aside>

</section>
<section id="slide-org971542b">
<h4 id="org971542b">What's Dwarf Fortress?</h4>
<img class="stretch" src="dwarf-fortress.png">

<aside class="notes">
<p>
Dwarf Fortress!
</p>

<p>
world simulation
</p>

<p>
lots of emergent behavior
</p>

<p>
players have fun because they create a lot of stories
</p>

<p>
What could possibly go wrong?
</p>

<p>
Let's find out!
</p>

</aside>

</section>
<section id="slide-orgc5e38bd">
<h3 id="orgc5e38bd">So what we're gonna aim for is…</h3>
<ul>
<li>A telnet connection for people</li>
<li>A world map</li>
<li>With time passing</li>
<li>Creatures that can move</li>
<li>Creatures that can die</li>
<li>Creatures that can reproduce</li>
<li>Balancing out the ecosystem</li>

</ul>
</section>
<section id="slide-org8ee9e2a">
<h3 id="org8ee9e2a">Disclaimer</h3>
<p>
I am not a game designer.
</p>

<p>
Nothing here constitutes <b>good</b> advice.
</p>

<p>
Seriously.
</p>
<aside class="notes">
<p>
There are many talks about good ideas.
</p>

<p>
This is a talk about bad ones.
</p>

</aside>
</section>
</section>
<section>
<section id="slide-org7ad79a0">
<h2 id="org7ad79a0">Roadmap</h2>
<ul>
<li><code>[0/6]</code>
<ul>
<li class="off"><code>[&#xa0;]</code> algorithm improvement</li>
<li class="off"><code>[&#xa0;]</code> extreme local state</li>
<li class="off"><code>[&#xa0;]</code> distributed state</li>
<li class="off"><code>[&#xa0;]</code> schedulers and the "tick"</li>
<li class="off"><code>[&#xa0;]</code> flooding processes</li>
<li class="off"><code>[&#xa0;]</code> linux oom killer</li>

</ul></li>

</ul>

<aside class="notes">
<ul>
<li>dip toes: algorithm improvement</li>
<li>wrong kind of state in processes</li>
<li>too much state in too many processes</li>
<li>beam vm schedulers (erlang virtual machine)</li>
<li>sending too many messages to processes</li>
<li>linux protects itself</li>

</ul>

</aside>
</section>
</section>
<section>
<section id="slide-org1cb9fb0">
<h2 id="org1cb9fb0">Algorithm improvement</h2>
<div class="outline-text-2" id="text-org1cb9fb0">
</div>
</section>
<section id="slide-org05ca737">
<h3 id="org05ca737">Misconception</h3>
<p>
A list is like an array
</p>

<p>
AKA "what's the deal with immutability anyway?"
</p>
</section>
<section id="slide-orga8b1883">
<h3 id="orga8b1883">Story</h3>
<p>
World: Graph → Edges and nodes
</p>

<ol>
<li>"nodes" are just ids</li>
<li>generate one edge to a random node from each node</li>
<li>collect, breadth-first, edges into islands</li>
<li>create single edges between islands</li>

</ol>
</section>
<section id="slide-org0c99b55">
<h4 id="org0c99b55">Key code</h4>
<div class="org-src-container">

<pre  class="src src-elixir"><code trim><span style="color: #597bc5;">def</span> <span style="color: #f9cf80;">traverse</span>(node, <span style="color: #71b9f8;">_</span>, visited) <span style="color: #597bc5;">when</span> node <span style="color: #597bc5;">in</span> visited, <span style="color: #87cefa;">do:</span> visited
<span style="color: #597bc5;">def</span> <span style="color: #f9cf80;">traverse</span>(node, edge_list, visited) <span style="color: #597bc5;">do</span>
  <span style="color: #c6b8fc;">visited</span> = [node | visited]
  <span style="color: #c6b8fc;">edges_from_node</span> = direct_edges(node, edge_list)
  <span style="color: #fdb86b;">Enum</span>.flat_map(
    edges_from_node,
    <span style="color: #597bc5;">fn</span>({<span style="color: #616161;">_s</span>, dest}) -&gt; traverse(dest, edge_list, visited) <span style="color: #597bc5;">end</span>
  )
<span style="color: #597bc5;">end</span>
</code></pre>
</div>

<aside class="notes">
<p>
flat_map is what we care about here
</p>

<p>
We return nested lists!
</p>

</aside>
</section>
<section id="slide-orgfe135cb">
<h3 id="orgfe135cb">Impact</h3>
<p>
Lots of data structures initialized recursively
</p>

<p>
Lots of data being copied when flattening
</p>

<p>
VERY SLOW
</p>
</section>
<section id="slide-orgb4dc55f">
<h3 id="orgb4dc55f">Fix</h3>
<div class="org-src-container">

<pre  class="src src-elixir"><code trim><span style="color: #597bc5;">def</span> <span style="color: #f9cf80;">traverse</span>(node, <span style="color: #71b9f8;">_</span>, visited) <span style="color: #597bc5;">when</span> node <span style="color: #597bc5;">in</span> visited, <span style="color: #87cefa;">do:</span> visited
<span style="color: #597bc5;">def</span> <span style="color: #f9cf80;">traverse</span>(node1, edge_list, visited) <span style="color: #597bc5;">do</span>
  <span style="color: #c6b8fc;">visited</span> = [node1 | visited]
  <span style="color: #c6b8fc;">edges_from_node</span> = direct_edges(node1, edge_list)
  <span style="color: #fdb86b;">Enum</span>.reduce(
    edges_from_node,
    visited,
    <span style="color: #597bc5;">fn</span>({<span style="color: #616161;">_a</span>, b}, acc) -&gt; traverse(b, edge_list, acc) <span style="color: #597bc5;">end</span>)
<span style="color: #597bc5;">end</span>
</code></pre>
</div>
<aside class="notes">
<p>
Concatenating linked lists is significantly more performant than creating new ones all the time
</p>

</aside>
</section>
<section id="slide-orgf2e0369">
<h3 id="orgf2e0369">Lessons</h3>
<ol class="fragment appear">
<li>copying data structures is expensive</li>

</ol>
</section>
<section id="slide-orgd954289">
<h3 id="orgd954289">Roadmap</h3>
<ul>
<li><code>[1/6]</code>
<ul>
<li class="on"><code>[X]</code> algorithm improvement</li>
<li class="off"><code>[&#xa0;]</code> extreme local state</li>
<li class="off"><code>[&#xa0;]</code> distributed state</li>
<li class="off"><code>[&#xa0;]</code> schedulers and the "tick"</li>
<li class="off"><code>[&#xa0;]</code> flooding processes</li>
<li class="off"><code>[&#xa0;]</code> linux oom killer</li>

</ul></li>

</ul>
</section>
</section>
<section>
<section id="slide-org21f76a5">
<h2 id="org21f76a5">Extreme local state</h2>
<div class="outline-text-2" id="text-org21f76a5">
</div>
</section>
<section id="slide-org5d8bf57">
<h3 id="org5d8bf57">Misconception</h3>
<p>
local state has got to be better than global state
</p>

<aside class="notes">
<p>
Alan Kay once wrote, "OOP to me means only messaging, local retention, and protection and hiding of state-process, and extreme late-binding of all things"
</p>

<p>
I thought.. What if.. I didn't use a database?
</p>

</aside>
</section>
<section id="slide-orgeada9ee">
<h3 id="orgeada9ee">Story</h3>
<p>
"Actor model?" Moar like extreme object-oriented, amirite?
</p>

<aside class="notes">
<ul>
<li>Creatures are GenServers</li>
<li>Local state: can have hat or sunglasses</li>
<li>"random action"</li>
<li>Imagine the person can say "Nice hat" or "Nice Sunglasses"</li>
<li>But they have to <i>check</i> first of course.</li>
<li>So they send a synchronous message to other processes to check what the state is</li>

</ul>

</aside>
</section>
<section id="slide-orgd50b615">
<h4 id="orgd50b615">Synchronous call</h4>
<p>
A → B
</p>

<p>
B → A
</p>

<p>
A → ☺
</p>

<aside class="notes">
<p>
Process A calls Process B
</p>

<p>
Process A blocks until it has received a response
</p>

<p>
A's message goes in B's mailbox, B eventually gets to it
</p>

</aside>
</section>
<section id="slide-org22e9804">
<h3 id="org22e9804">Impact</h3>
<p>
Alice asks Bob <i>(and waits)</i>
</p>

<p>
Bob asks Charlie  <i>(and waits)</i>
</p>

<p>
Charlie asks Alice  <i>(and waits)</i>
</p>

<aside class="notes">
<ul>
<li>But.. Other processes are all doing the same thing!</li>

</ul>

<p>
DEADLOCKS!
</p>

<p>
Dun dun dunnn.
</p>

</aside>
</section>
<section id="slide-orgd21ddff">
<h4 id="orgd21ddff">Dining philosophers</h4>
<p>
The classic concurrency problem.
</p>

<p>
Check it out.
</p>

<aside class="notes">
<p>
Each philosopher must alternately think and eat.
</p>

<p>
However, a philosopher can only eat spaghetti when they have both left and right forks.
</p>

<p>
Each fork can be held by only one philosopher and so a philosopher can use the fork only if it is not being used by another philosopher.
</p>

<p>
After an individual philosopher finishes eating, they need to put down both forks so that the forks become available to others.
</p>

<p>
A philosopher can take the fork on their right or the one on their left as they become available, but cannot start eating before getting both forks.
</p>

</aside>
</section>
<section id="slide-orga7b6503">
<h3 id="orga7b6503">Fix</h3>
<p>
Tell, don't ask.
</p>
<aside class="notes">
<p>
Essentially, don't ask for information, just say what you want to have happen.
</p>

<p>
This is a paradigm shift, and it causes fundamental architectural changes.
</p>

</aside>
</section>
<section id="slide-org4f5b603">
<h3 id="org4f5b603">Lessons</h3>
<ol>
<li>copying data structures is expensive</li>
<li class="fragment appear">tell, don't ask</li>

</ol>
</section>
<section id="slide-org26a3d1d">
<h3 id="org26a3d1d">Roadmap</h3>
<ul>
<li><code>[2/6]</code>
<ul>
<li class="on"><code>[X]</code> algorithm improvement</li>
<li class="on"><code>[X]</code> extreme local state</li>
<li class="off"><code>[&#xa0;]</code> distributed state</li>
<li class="off"><code>[&#xa0;]</code> schedulers and the "tick"</li>
<li class="off"><code>[&#xa0;]</code> flooding processes</li>
<li class="off"><code>[&#xa0;]</code> linux oom killer</li>

</ul></li>

</ul>
</section>
</section>
<section>
<section id="slide-orgfabb073">
<h2 id="orgfabb073">Distributed state</h2>
<aside class="notes">
<p>
I'd love to say that I figured out "some state is global" when I ran into the deadlocks
</p>

<p>
But Ι really wanted to not do databases. It's unclear whether I'm too stubborn or not smart enough.
</p>

<p>
Or both.
</p>

</aside>
</section>
<section id="slide-org4565415">
<h3 id="org4565415">Misconception</h3>
<p>
Fewer synchronous calls will reduce the opportunity of deadlocks
</p>
<aside class="notes">
<p>
real problem is which synchronous calls, not how many
</p>

<p>
In this story, I'm not even trying to solve the correct problem from the previous story
</p>

<p>
... Because I had misdiagnosed (which is a whole other talk)
</p>

<p>
I'm playing the race condition game
</p>

</aside>
</section>
<section id="slide-org3a52e1a">
<h3 id="org3a52e1a">Story</h3>
<p>
Moar local state in moar local places
</p>
<aside class="notes">
<p>
Instead of "each process has its own state and they'll be queried for state" ...
</p>

</aside>
</section>
<section id="slide-org2507584">
<h4 id="org2507584">Spaghetti state</h4>
<ul>
<li>Dwarf has location exits, location id</li>
<li>locations have dwarf info</li>

</ul>
<aside class="notes">
<p>
I started to copy some data into each process, because that allowed me to do fewer synchronous calls.
</p>

<p>
There's a consequence here, right?
</p>

<p>
Every time a dwarf moves, a lot of state has to be updated
</p>

</aside>
</section>
<section id="slide-org77cb406">
<h3 id="org77cb406">Impact</h3>
<p>
Accidentally multiple sources of truths
</p>
<aside class="notes">
<p>
I created caches. Caches are very hard to invalidate.
</p>

<p>
Eric mentioned this in his keynote this morning.
</p>

<p>
It's one of the two hardest problems in programming, along with naming and off-by-one errors.
</p>

</aside>
</section>
<section id="slide-org2eb91c1">
<h3 id="org2eb91c1">Fix</h3>
<p>
Some state is global
</p>
<aside class="notes">
<p>
But there's a deep truth here
</p>

<p>
choices for where the state goes
</p>

<p>
hot deploys: basically inject code in running application, Erlang provides hooks for upgrading state
</p>

<p>
But that's a whole other talk
</p>

<p>
the big elixir last year
</p>

<p>
Desmond Bowe gave a talk about "stateful servers"
</p>

<p>
Highly recommended
</p>

</aside>
</section>
<section id="slide-orge2483cf">
<h3 id="orge2483cf">Lessons</h3>
<ol>
<li>copying data structures is expensive</li>
<li>tell, don't ask</li>
<li class="fragment appear">prefer a single source of truth</li>

</ol>
</section>
<section id="slide-orgae53a3d">
<h3 id="orgae53a3d">Roadmap</h3>
<ul>
<li><code>[3/6]</code>
<ul>
<li class="on"><code>[X]</code> algorithm improvement</li>
<li class="on"><code>[X]</code> extreme local state</li>
<li class="on"><code>[X]</code> distributed state</li>
<li class="off"><code>[&#xa0;]</code> schedulers and the "tick"</li>
<li class="off"><code>[&#xa0;]</code> flooding processes</li>
<li class="off"><code>[&#xa0;]</code> linux oom killer</li>

</ul></li>

</ul>
</section>
</section>
<section>
<section id="slide-orgf6a2f32">
<h2 id="orgf6a2f32">Schedulers and the "tick"</h2>
<aside class="notes">
<p>
"game of life"
</p>

<p>
the "tick" is the unit of time: every time a tick happens, everything in the world happens
</p>

</aside>
</section>
<section id="slide-org367994c">
<h3 id="org367994c">Game of Life</h3>
<img class="stretch" src="gameoflife.png">

<aside class="notes">
<p>
The short version:
</p>

<p>
All the filled cells are "alive"
</p>

<p>
Current board state is the input for the next board state
</p>

<p>
Computation for new state happens on every tick
</p>

</aside>
</section>
<section id="slide-org700a2f8">
<h3 id="org700a2f8">Misconception</h3>
<p>
There won't be a noticeable impact to sending all my creatures a message at the same time
</p>

<aside class="notes">
<p>
when the heartbeat happens every process acts
</p>

</aside>
</section>
<section id="slide-orgeae5855">
<h3 id="orgeae5855">Story</h3>
<p>
The tick (not the blue one)
</p>

<aside class="notes">
<p>
Registry (broadcast)
</p>

<p>
Petimer (managed recurring messages)
</p>

<p>
"Heartbeat manager process"
</p>

<p>
Pause life
</p>

</aside>
</section>
<section id="slide-org13ab987">
<h3 id="org13ab987">Impact</h3>
<p>
All schedulers triggered at same time - literally a heartbeat of intense CPU usage on the box
</p>
<img class="stretch" src="scheduler.png">
<aside class="notes">
<p>
BEAM VM has a pre-emptive scheduler
</p>

<p>
This means it coordinates the processes' actions, and that means it helps allocate CPU usage.
</p>

<p>
for a game - heartbeat every 1-6 seconds
</p>

<p>
So this was an incredibly regular cadence of CPU usage, and that also meant there was a clear upper bound to growth: at some point, CPUs wouldn't be able to allow every process to make their move at the same time.
</p>

</aside>
</section>
<section id="slide-org82689bb">
<h3 id="org82689bb">Fix</h3>
<p>
More or less "any other way"
</p>

<p>
I opted for "all manage their own ticks"
</p>

<p>
Never mind how untestable that makes the system
</p>

<p>
Smarter fix is probably "bounded global ticks" so that some control can be exerted more easily
</p>
<aside class="notes">
<p>
Eric vaguely pointed at something similar in his keynote
</p>

<p>
if you have a couple of rooms - control those with its own heartbeat manager
</p>

<p>
really didn't want "everything to act at the same time"
</p>

<p>
I wanted events - this is Elixir, damnit!
</p>

</aside>
</section>
<section id="slide-orge94a6a9">
<h3 id="orge94a6a9">Lessons</h3>
<ol>
<li>copying data structures is expensive</li>
<li>tell, don't ask</li>
<li>prefer a single source of truth</li>
<li class="fragment appear">understand your system's CPU needs</li>

</ol>
</section>
<section id="slide-org98ee4d6">
<h3 id="org98ee4d6">Roadmap</h3>
<ul>
<li><code>[4/6]</code>
<ul>
<li class="on"><code>[X]</code> algorithm improvement</li>
<li class="on"><code>[X]</code> extreme local state</li>
<li class="on"><code>[X]</code> distributed state</li>
<li class="on"><code>[X]</code> schedulers and the "tick"</li>
<li class="off"><code>[&#xa0;]</code> flooding processes</li>
<li class="off"><code>[&#xa0;]</code> linux oom killer</li>

</ul></li>

</ul>
</section>
</section>
<section>
<section id="slide-orgf9f6fb3">
<h2 id="orgf9f6fb3">flooding processes</h2>
<div class="outline-text-2" id="text-orgf9f6fb3">
</div>
</section>
<section id="slide-orgf74b8b0">
<h3 id="orgf74b8b0">Misconception</h3>
<p>
It's hard to send a single process too many messages
</p>
</section>
<section id="slide-org516165d">
<h3 id="org516165d">Story</h3>
<p>
Every action is an event
</p>

<p>
Dwarlixir is decentralized
</p>
<aside class="notes">
<p>
Apparently Eric had some version of this problem too
</p>

<ul>
<li>every time something would happen in the "room" process</li>
<li>an event would go to every living creature in the room so they could respond to it</li>
<li>and players would have this event transformed to text</li>
<li>again - every action in a room goes to every creature. that's N^2.</li>
<li>N^2 is bad.</li>
<li>with all the births, N was always increasing</li>

</ul>

</aside>
</section>
<section id="slide-org07788de">
<h3 id="org07788de">Impact</h3>
<ul>
<li>The locations crashed</li>
<li>The mobs crashed</li>
<li>The process that printed stuff to the console crashed</li>

</ul>
<aside class="notes">
<p>

</p>

<p>
What did it have to do?
</p>
<ul>
<li>create a string</li>
<li>send it over the network (telnet)</li>

</ul>

<p>
I mentioned the pre-emptive scheduler before, here's how it works
</p>

<p>
Processes have "Reductions"
</p>

<p>
From Prolog - goal reduction, a building block action of a larger operation
</p>

<p>
pre-emptive scheduler means processes only get so many reductions before another process gets their turn
</p>

<p>
sending a message gets more expensive as THE RECEIVING PROCESS has more messages in the mailbox
</p>

<p>
elements of self-balancing in the VM
</p>

<p>
force rest of system to slow down to allow congestion to clear up
</p>

<p>
Crucially in my case: CPU time higher than time between messages
</p>

<p>
Processes are "single-threaded", process messages one at a time
</p>

<p>
Possibly constructing strings instead of IO strings made things worse
</p>

<p>
So this means the printer process had an ever-increasing mailbox
</p>

</aside>
</section>
<section id="slide-org734872a">
<h3 id="org734872a">Fix</h3>
<ol>
<li>Cry</li>
<li>Batch messages</li>
<li>Research game design patterns</li>

</ol>
<aside class="notes">
<p>
realization: current implementation needed more of a single heartbeat
</p>

<p>
Bad for user experience: non-live messages, can't respond reasonably
</p>

<p>
... Took me to Entity Component System - game design pattern
</p>

<p>
And that took me to a complete overhaul of the system
</p>

<p>
And that's a whole other talk about macros (might piggyback on top of Bruce's talk from yesterday and give this talk next year)
</p>

</aside>
</section>
<section id="slide-org72e3da2">
<h3 id="org72e3da2">Lessons</h3>
<ol>
<li>copying data structures is expensive</li>
<li>tell, don't ask</li>
<li>prefer a single source of truth</li>
<li>understand your system's CPU needs</li>
<li class="fragment appear">actors are single-threaded</li>

</ol>
</section>
<section id="slide-org46b3480">
<h3 id="org46b3480">Roadmap</h3>
<ul>
<li><code>[5/6]</code>
<ul>
<li class="on"><code>[X]</code> algorithm improvement</li>
<li class="on"><code>[X]</code> extreme local state</li>
<li class="on"><code>[X]</code> distributed state</li>
<li class="on"><code>[X]</code> schedulers and the "tick"</li>
<li class="on"><code>[X]</code> flooding processes</li>
<li class="off"><code>[&#xa0;]</code> linux oom killer</li>

</ul></li>

</ul>
</section>
</section>
<section>
<section id="slide-org3760349">
<h2 id="org3760349">linux OOM killer</h2>
<div class="outline-text-2" id="text-org3760349">
</div>
</section>
<section id="slide-orgca3ff6b">
<h3 id="orgca3ff6b">Misconception</h3>
<p>
My world simulation won't grow unbounded in RAM usage
</p>
<aside class="notes">
<p>
remember when Ι said I would balance the ecosystem?
</p>

</aside>
</section>
<section id="slide-org03eedc9">
<h3 id="org03eedc9">Story</h3>
<p>
"Emergent Behavior"
</p>
<aside class="notes">
<p>
Once I had fixed all the other problems, the system would be relatively stable
</p>

<p>
Or so I thought
</p>

<p>
I'd launch the game, and after an hour and a half someone would say "Hey, your game is down"
</p>

</aside>
</section>
<section id="slide-org4a9fb72">
<h3 id="org4a9fb72">Impact</h3>
<p>
The operating system does what it needs to do to stay up
</p>
<img class="stretch" src="htop.png">
<aside class="notes">
<p>
Linux has an out of memory killer
</p>

<p>
kill non-essential OS-level processes using too much RAM
</p>

<p>
We don't see this often because for the most part, the RAM that is "used" is actually free (it's not released back to the operating system)
</p>

<p>
I eventually figured it out because Ι launched the game and logged on to it, and on the server I launched htop
</p>

<p>
To a large extent, this actually was an indication of success
</p>

<p>
world simulation: reproduction and death
</p>

<p>
balancing lifespan with reproductive maturity, likelihood of becoming pregnant, and length of pregnancy is hard
</p>

</aside>
</section>
<section id="slide-orgc811bdf">
<h3 id="orgc811bdf">Fix</h3>
<p>
Ecosystem
</p>
<aside class="notes">
<p>
I literally created an Elixir process that would check regularly how much RAM was available
</p>

<p>
If less than 15% RAM was available, it would stop births
</p>

<p>
If more than 20% RAM available, allow births
</p>

<p>
prod systems are so much more predictable
</p>

</aside>
</section>
<section id="slide-org725f167">
<h3 id="org725f167">Lessons</h3>
<ol>
<li>copying data structures is expensive</li>
<li>tell, don't ask</li>
<li>prefer a single source of truth</li>
<li>understand your system's CPU needs</li>
<li>actors are single-threaded</li>
<li class="fragment appear">understand your system's RAM needs</li>

</ol>
</section>
<section id="slide-org78eb03c">
<h3 id="org78eb03c">Roadmap</h3>
<ul>
<li><code>[6/6]</code>
<ul>
<li class="on"><code>[X]</code> algorithm improvement</li>
<li class="on"><code>[X]</code> extreme local state</li>
<li class="on"><code>[X]</code> distributed state</li>
<li class="on"><code>[X]</code> schedulers and the "tick"</li>
<li class="on"><code>[X]</code> flooding processes</li>
<li class="on"><code>[X]</code> linux oom killer</li>

</ul></li>

</ul>
</section>
</section>
<section>
<section id="slide-org8e3d07a">
<h2 id="org8e3d07a">BONUS</h2>
</section>
</section>
<section>
<section id="slide-org7006210">
<h2 id="org7006210">Yak shaving</h2>
<p>
It's yaks all the way down
</p>
</section>
<section id="slide-orgfd505d5">
<h3 id="orgfd505d5">Language Server Protocol</h3>
<p>
One server
</p>

<p>
One plugin per text editor
</p>

<aside class="notes">
<p>
Thanks Microsoft!
</p>

<p>
Code completion, jump to definition, display documentation, etc.
</p>

<p>
This is what makes VSCode rock with Javascript
</p>

</aside>
</section>
<section id="slide-org8ff8f61">
<h3 id="org8ff8f61">Editors matter</h3>
<p>
I use emacs
</p>

<p>
primary plugin: alchemist.el
</p>
<aside class="notes">
<p>
All-encompassing tool for emacs
</p>

<p>
Tried to contribute, make some adjustments
</p>

<p>
Eventually tried to rewrite backend
</p>

<p>
Eventually just started a separate project only with LSP
</p>

</aside>
</section>
<section id="slide-org1af8d80">
<h3 id="org1af8d80">Existing LSP projects</h3>
<ul>
<li>Marlus Saraiva's <code>elixir_sense</code></li>
<li>Jake Becker's <code>elixir-ls</code></li>

</ul>

<aside class="notes">
<p>
elixir_sense is project analysis
</p>

<p>
elixir-ls is an editor-independent LS server
</p>

<p>
Both seemed "abandoned" - couldn't reach the authors
</p>

</aside>
</section>
<section id="slide-org375bf09">
<h3 id="org375bf09">Created an org on Github</h3>
<p>
<a href="https://github.com/elixir-lsp">https://github.com/elixir-lsp</a>
forked the projects, opened issues on original projects to explain why
</p>
</section>
<section id="slide-orgaf32483">
<h3 id="orgaf32483">Created channel on Elixir Slack</h3>
<p>
elixir-lang.slack.com
</p>

<p>
#language-server
</p>
</section>
<section id="slide-org1e116f6">
<h3 id="org1e116f6">Recruited folks</h3>
<ul>
<li>@jason_axelson</li>
<li>@asummers</li>

</ul>
<aside class="notes">
<p>
Jason is the most active
</p>

</aside>
</section>
<section id="slide-org72cfea8">
<h3 id="org72cfea8">Eventually the author of elixir_sense joined</h3>
<p>
Woot!
</p>
</section>
<section id="slide-orgd8ed693">
<h3 id="orgd8ed693">Community is active</h3>
<p>
WOOT!
</p>
<aside class="notes">
<p>
Join us!
</p>

</aside>
</section>
<section id="slide-org6e05fdc">
<h3 id="org6e05fdc">Last open loop</h3>
<p>
Still haven't established communication with Jake Becker
</p>

<aside class="notes">
<p>
Hey Jake, if you're out there... Please reach out!
</p>

<p>
We would love the opportunity to work with you on this community project
</p>

</aside>
</section>
<section id="slide-org9665a6d">
<h3 id="org9665a6d">Yaks</h3>
<ul>
<li>Dwarlixir</li>
<li>ECStatic</li>
<li>alchemist.el</li>
<li>elixir-ls</li>
<li>an actual community</li>

</ul>

<aside class="notes">
<p>
Only took me about a year...
</p>

</aside>
</section>
</section>
<section>
<section id="slide-orgf68d8ee">
<h2 id="orgf68d8ee">Resources</h2>
<ul>
<li><a href="https://github.com/Trevoke/dwarlixir">Dwarlixir on Github</a></li>
<li><a href="https://github.com/elixir-lsp">Elixir LSP on Github</a></li>
<li>elixir-lang.slack.com → #language-server</li>
<li><a href="https://www.kernel.org/doc/gorman/html/understand/understand016.html">Linux OOM killer</a></li>
<li><a href="http://userpage.fu-berlin.de/~ram/pub/pub_jf47ht81Ht/doc_kay_oop_en">Alan Kay on OOP</a></li>
<li><a href="http://zxq9.com/erlmud/">ErlMud</a></li>
<li><a href="https://github.com/Trevoke/ecstatic">Ecstatic on Github</a></li>

</ul>
</section>
</section>
<section>
<section id="slide-orga5fdef4">
<h2 id="orga5fdef4">Q&amp;A</h2>
<p>
If I don't know the answer, I'll make up a good one
</p>
</section>
</section>
</div>
</div>
<script src="./reveal.js-3.8.0/js/reveal.js"></script>

<script>
// Full list of configuration options available here:
// https://github.com/hakimel/reveal.js#configuration
Reveal.initialize({
multiplex: {
    secret: '', // null if client
    id: '', // id, obtained from socket.io server
    url: '' // Location of socket.io server
},

// Optional libraries used to extend on reveal.js
dependencies: [
 { src: './reveal.js-3.8.0/lib/js/classList.js', condition: function() { return !document.body.classList; } },
 { src: './reveal.js-3.8.0/plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
 { src: './reveal.js-3.8.0/plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
 { src: './reveal.js-3.8.0/plugin/zoom-js/zoom.js', async: true, condition: function() { return !!document.body.classList; } },
 { src: './reveal.js-3.8.0/plugin/notes/notes.js', async: true, condition: function() { return !!document.body.classList; } }]
});
</script>
</body>
</html>
